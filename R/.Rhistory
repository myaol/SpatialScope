X,
scGEM_init,
model_paras = list(b0 = 0.01, g1 = 5, g2 = 1, g3 = 1/3, g4 = 2/3),
max_est = 50,
subtree_size = c(1, 20),
batch_size = 2000,
n_epoch = 50,
learning_rate = 0.001
)
library(pbmcapply)
packageVersion("pbmcapply")  # Should return a version number
str(X)
str(scGEM_init)
setdiff(rownames(X), scGEM_init$gene)  # List missing genes
print(length(scGEM_init$gene))
print(length(rownames(X)))
print(dim(X))
print(length(filtered_genes))  # Number of removed genes
filtered_genes <- setdiff(rownames(X), scGEM_init$gene)  # Missing genes
print(length(filtered_genes))
# use filtered genes as input
# Find common genes between X and scGEM_init
common_genes <- intersect(rownames(X), scGEM_init$gene)
# Subset X to only include the common genes
X_subset <- X[common_genes, ]  # Now it should be (51806 genes × 1000 cells)
# Verify the dimensions
print(dim(X_subset))
scGEM_trained_mb <- minibatchInfer(
X_subset,
scGEM_init,
model_paras = list(b0 = 0.01, g1 = 5, g2 = 1, g3 = 1/3, g4 = 2/3),
max_est = 50,
subtree_size = c(1, 20),
batch_size = 2000,
n_epoch = 50,
learning_rate = 0.001
)
print(dim(X_subset))
print(length(scGEM_init$gene))
print(length(scGEM_init$cell))
# Verify the dimensions
print(dim(X_subset))
scGEM_trained_mb <- minibatchInfer(
X_subset,
scGEM_init,
model_paras = list(b0 = 0.01, g1 = 5, g2 = 1, g3 = 1/3, g4 = 2/3),
max_est = 50,
subtree_size = c(1, 20),
batch_size = 2000,
n_epoch = 50,
learning_rate = 0.001,
parallel = FALSE # (ask aodong) is it ok to put this?
)
scGEM_trained_mb <- minibatchInfer(
X_subset,
scGEM_init,
model_paras = list(b0 = 0.01, g1 = 5, g2 = 1, g3 = 1/3, g4 = 2/3),
max_est = 50,
subtree_size = c(1, 20),
batch_size = 2000,
n_epoch = 50,
learning_rate = 0.001,
)
print(dim(X_subset))
print(sum(X_subset@x))
debug(minibatchInfer)
scGEM_trained_mb <- minibatchInfer(X_subset, scGEM_init, ...)
debug(minibatchInfer)
traceback()
# Subset X to only include the common genes
X_subset <- X[common_genes, ]  # Now it should be (51806 genes × 1000 cells)
# Verify the dimensions
print(dim(X_subset))
options(mc.cores = 1)  # Force single-threaded execution
scGEM_trained_mb <- minibatchInfer(
X_subset,
scGEM_init,
model_paras = list(b0 = 0.01, g1 = 5, g2 = 1, g3 = 1/3, g4 = 2/3),
max_est = 50,
subtree_size = c(1, 20),
batch_size = 2000,
n_epoch = 50,
learning_rate = 0.001,
)
print(length(miss_gene))
miss_gene <- scGEM_init$gene[!scGEM_init$gene %in% rownames(X)]
print(length(miss_gene))
print(sum(is.na(matched_genes)))
print(length(matched_genes))
print(dim(X))
print(N)
print(batch_size)
print(length(batches))
print(length(batches))
print(length(batches))
scGEM_trained_mb <- minibatchInfer(
X_subset,
scGEM_init,
model_paras = list(b0 = 0.01, g1 = 5, g2 = 1, g3 = 1/3, g4 = 2/3),
max_est = 50,
subtree_size = c(1, 20),
batch_size = 50, # (ask aodong: I changed the batch_size)
n_epoch = 50,
learning_rate = 0.001,
)
# Subset X to only include the common genes
X_subset <- X[common_genes, ]  # Now it should be (51806 genes × 1000 cells)
# ========================================================
# 6. INITIALIZE SCGEM TOPIC MODEL
# ========================================================
scGEM_init <- initTree(
X,
num_topics = c(5, 4, 3),  # Three-layer hierarchical topic model
blacklist_genes = "^MT|^RP|^HSP|B2M|MALAT1",  # Remove unwanted genes # which caused the gene numbers from 56239 to 51806?
rm.housekeeping_genes = TRUE
)
# use filtered genes as input
# Find common genes between X and scGEM_init
common_genes <- intersect(rownames(X), scGEM_init$gene)
# Subset X to only include the common genes
X_subset <- X[common_genes, ]  # Now it should be (51806 genes × 1000 cells)
# Verify the dimensions
print(dim(X_subset))
options(mc.cores = 1)  # Force single-threaded execution
scGEM_trained_mb <- minibatchInfer(
X_subset,
scGEM_init,
model_paras = list(b0 = 0.01, g1 = 5, g2 = 1, g3 = 1/3, g4 = 2/3),
max_est = 50,
subtree_size = c(1, 20),
batch_size = 50, # (ask aodong: I changed the batch_size)
n_epoch = 50,
learning_rate = 0.001,
)
undebug(minibatchInfer)
Browse[3]> undebug(minibatchInfer)
undebug(minibatchInfer)
undebug(minibatchInfer)
# use filtered genes as input
# Find common genes between X and scGEM_init
common_genes <- intersect(rownames(X), scGEM_init$gene)
# Subset X to only include the common genes
X_subset <- X[common_genes, ]  # Now it should be (51806 genes × 1000 cells)
# Verify the dimensions
print(dim(X_subset))
options(mc.cores = 1)  # Force single-threaded execution
scGEM_trained_mb <- minibatchInfer(
X_subset,
scGEM_init,
model_paras = list(b0 = 0.01, g1 = 5, g2 = 1, g3 = 1/3, g4 = 2/3),
max_est = 50,
subtree_size = c(1, 20),
batch_size = 50, # (ask aodong: I changed the batch_size)
n_epoch = 50,
learning_rate = 0.001,
)
print(str(batch_results))
# ========================================================
# 3️. CONVERT TO SPARSE MATRIX IN R
# ========================================================
sparse_matrix <- sparseMatrix(
i = indices + 1,  # R uses 1-based indexing, so add 1
p = indptr,
x = data,
dims = shape,
repr = "C"  # Explicitly specifying Column-oriented storage (CSC)
)
length(indptr) == shape[2] + 1
max(indptr) == length(data)
# ========================================================
# 2. LOAD SPARSE MATRIX FROM HDF5 FILE
# ========================================================
h5_file_path <- "/Users/markdana/Downloads/Lu_lab/Lung_cancer/lung_cancer_rawcount_values_debug.h5"
if (!file.exists(h5_file_path)) {
stop("ERROR: HDF5 file not found. Check the path!")
} else {
print("File found. Proceeding...")
}
# Check if variables are correctly loaded
print(length(data))
print(length(indices))
print(length(indptr))
print(shape)
# ========================================================
# 3️. CONVERT TO SPARSE MATRIX IN R
# ========================================================
sparse_matrix <- sparseMatrix(
i = indices + 1,  # R uses 1-based indexing, so add 1
p = indptr,
x = data,
dims = shape,
repr = "C"  # Explicitly specifying Column-oriented storage (CSC)
)
h5_file <- H5File$new(h5_file_path, mode = "r")
# Extract sparse matrix components
data <- h5_file[["matrix/data"]][]
indices <- h5_file[["matrix/indices"]][]
indptr <- h5_file[["matrix/indptr"]][]
shape <- h5_file[["matrix/shape"]][]
gene_names <- h5_file[["matrix/gene_names"]][]
cell_names <- h5_file[["matrix/cell_names"]][]
# Close the HDF5 file to free memory
h5_file$close()
# Determine matrix format
if (length(indptr) == shape[1] + 1) {
cat("Detected CSR format\n")
# Create a CSR matrix
sparse_matrix_CSR <- sparseMatrix(
i = indices + 1,  # Convert 0-based to 1-based indexing
p = indptr,
x = data,
dims = c(shape[1], shape[2]),  # CSR: (rows, cols)
repr = "R"
)
# Convert CSR to CSC by transposing
sparse_matrix <- t(sparse_matrix_CSR)
} else if (length(indptr) == shape[2] + 1) {
cat("Detected CSC format\n")
# Directly create a CSC matrix
sparse_matrix <- sparseMatrix(
i = indices + 1,  # Convert 0-based to 1-based indexing
p = indptr,
x = data,
dims = shape,
repr = "C"
)
} else {
stop("Unknown sparse matrix format! Check 'indptr' and 'shape'.")
}
# Determine matrix format
if (length(indptr) == shape[1] + 1) {
cat("Detected CSR format\n")
# Create a CSR matrix
sparse_matrix_CSR <- sparseMatrix(
i = indices + 1,  # Convert 0-based to 1-based indexing
p = indptr,
x = data,
dims = c(shape[2], shape[1]),  # CSR: (rows, cols)
repr = "R"
)
# Convert CSR to CSC by transposing
sparse_matrix <- t(sparse_matrix_CSR)
} else if (length(indptr) == shape[2] + 1) {
cat("Detected CSC format\n")
# Directly create a CSC matrix
sparse_matrix <- sparseMatrix(
i = indices + 1,  # Convert 0-based to 1-based indexing
p = indptr,
x = data,
dims = shape,
repr = "C"
)
} else {
stop("Unknown sparse matrix format! Check 'indptr' and 'shape'.")
}
print(class(sparse_matrix))  # Should be "dgCMatrix"
# Determine matrix format
cat("Detected CSR format\n")
# Create a CSR matrix
sparse_matrix_CSR <- sparseMatrix(
i = indices + 1,  # Convert 0-based to 1-based indexing
p = indptr,
x = data,
dims = c(shape[2], shape[1]),  # CSR: (rows, cols)
repr = "R"
)
# Convert CSR to CSC by transposing
sparse_matrix <- t(sparse_matrix_CSR)
print(class(sparse_matrix))  # Should be "dgCMatrix"
print(dim(sparse_matrix))  # Should match original shape
# Determine matrix format
if (length(indptr) == shape[1] + 1) {
# Create a CSR matrix
sparse_matrix_CSR <- sparseMatrix(
i = indices + 1,  # Convert 0-based to 1-based indexing
p = indptr,
x = data,
dims = c(shape[2], shape[1]),  # CSR: (rows, cols)
repr = "R"
)
# Convert CSR to CSC by transposing
sparse_matrix <- as(t(sparse_matrix_CSR), "CsparseMatrix")
print(class(sparse_matrix))  # Should be "dgCMatrix"
print(dim(sparse_matrix))  # Should match original shape
Q
# Close the HDF5 file to free memory
h5_file$close()
# Determine matrix format
if (length(indptr) == shape[1] + 1) {
# Close the HDF5 file to free memory
h5_file$close()
# Determine matrix format
if (length(indptr) == shape[1] + 1) {
cat("Detected CSR format\n")
# Create a CSR matrix
sparse_matrix_CSR <- sparseMatrix(
i = indices + 1,  # Convert 0-based to 1-based indexing
p = indptr,
x = data,
dims = c(shape[2], shape[1]),  # CSR: (rows, cols)
repr = "R"
)
# Convert CSR to CSC by transposing
sparse_matrix <- as(t(sparse_matrix_CSR), "CsparseMatrix")
}
print(class(sparse_matrix))  # Should be "dgCMatrix"
h5_file <- H5File$new(h5_file_path, mode = "r")
memory.limit()
gc()
# ========================================================
# 1. LOAD REQUIRED PACKAGES
# ========================================================
rm(sparse_matrix)
gc()
ls()
gc()
rm(list = ls())
gc()
ls()
install.packages("bigmemory")
library(bigmemory)
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
SN84_A121573_Rep2 <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(SN84_A121573_Rep2, "Welcome!", show_image = TRUE)
source("~/Downloads/spatialscope_11112025.R")
SN84_A121573_Rep2 <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(SN84_A121573_Rep2, "Welcome!", show_image = TRUE)
remove.packages("SpatialScope")
library(SpatialScope)
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
SN84_A121573_Rep2 <- readRDS("/Users/markdana/Downloads/SN84_A121573_Rep2.rds")
run_spatial_selector(SN84_A121573_Rep2, "Welcome!", show_image = TRUE)
library(SpatialScope)
run_SpatialScope("demo")
my_data <- readRDS("/Users/markdana/Downloads/C57BL10_relabelled_new.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment"， show_image = TRUE)
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
my_data <- readRDS("/Users/markdana/Downloads/P1N_Spatial.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
my_data <- readRDS("/Users/markdana/Downloads/P1N_Spatial.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
View(my_data)
View(SN84_A121573_Rep2)
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
View(my_data)
View(SN84_A121573_Rep2)
my_data <- readRDS("/Users/markdana/Downloads/C57BL10_relabelled_new.rds")
View(my_data)
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
library(SpatialScope)
run_SpatialScope("demo")
library(SpatialScope)
run_SpatialScope("demo")
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
my_data <- readRDS("/Users/markdana/Downloads/P1N_Spatial.rds")
library(SpatialScope)
run_SpatialScope("demo")
library(SpatialScope)
run_SpatialScope("demo")
my_data <- readRDS("/Users/markdana/Downloads/C57BL10_relabelled_new.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
remove.packages("SpatialScope")
if (!requireNamespace("BiocManager", quietly = TRUE)) {
install.packages("BiocManager")
}
BiocManager::install(c("Seurat", "GSVA"))
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
my_data <- readRDS("/Users/markdana/Downloads/C57BL10_relabelled_new.rds")
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
my_data <- SeuratObject::UpdateSeuratObject(my_data)
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
my_data <- readRDS("/Users/markdana/Downloads/C57BL10_relabelled_new.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
my_data <- SeuratObject::UpdateSeuratObject(my_data)
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
my_data <- readRDS("/Users/markdana/Downloads/C57BL10_relabelled_new.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
library(SpatialScope)
run_SpatialScope("demo")
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
remove.packages("SpatialScope")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
remove.packages("SpatialScope")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
source("~/Downloads/spatialscope_11112025_check.R")
SN84_A121573_Rep2 <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(SN84_A121573_Rep2, "Welcome!", show_image = TRUE)
source("~/Downloads/spatialscope_11112025_check.R")
SN84_A121573_Rep2 <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(SN84_A121573_Rep2, "Welcome!", show_image = TRUE)
SN84_A121573_Rep2 <- readRDS("/Users/markdana/Downloads/P1N_Spatial.rds")
run_spatial_selector(SN84_A121573_Rep2, "Welcome!", show_image = TRUE)
source("~/Downloads/spatialscope_11112025_check.R")
SN84_A121573_Rep2 <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(SN84_A121573_Rep2, "Welcome!", show_image = TRUE)
cat("Before normalization - checking images...\n")
print(names(spatial_obj@images))
spatial_obj <- NormalizeData(spatial_obj, assay = use_assay, verbose = TRUE)
source("~/Downloads/spatialscope_11112025_check.R")
SN84_A121573_Rep2 <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(SN84_A121573_Rep2, "Welcome!", show_image = TRUE)
source("~/Downloads/spatialscope_11112025_check.R")
SN84_A121573_Rep2 <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(SN84_A121573_Rep2, "Welcome!", show_image = TRUE)
remove.packages("SpatialScope")
getAnywhere(run_SpatialScope)
getAnywhere(run_spatial_selector)
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
run_SpatialScope("demo")
.rs.restartR()
if ("SpatialScope" %in% installed.packages()) {
remove.packages("SpatialScope")
}
file.exists("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
library(qs)
rm -rf ~/Library/R/arm64/4.4/library/SpatialScope
install.packages("devtools")  # if not already installed
devtools::install_github("myaol/SpatialScope", force = TRUE)
library(SpatialScope)
install.packages("devtools")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
library(SpatialScope)
run_SpatialScope("demo")
Seurat::GetTissueCoordinates(my_data)
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
devtools::document()
setwd("/Users/markdana/Downloads/SpatialScopePublic")
devtools::document()
devtools::install(force = TRUE)
.rs.restartR()
library(SpatialScope)
run_SpatialScope("demo")
library(SpatialScope)
rm.package("SpatialScope")
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
setwd("~/Downloads/SpatialScopePublic/R")
remove.packages("SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
setwd("~/Downloads/SpatialScopePublic/R")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
my_data <- readRDS("/Users/markdana/Downloads/HCC-1L_filtered_srt.rds")
run_spatial_selector(my_data, sample_name = "MyExperiment", show_image = TRUE)
remove.packages("SpatialScope")
# install.packages("devtools")
devtools::install_github("myaol/SpatialScope")
library(SpatialScope)
run_SpatialScope("demo")
